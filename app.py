import streamlit as st
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage

# --- æ‰‹é †4-4: ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ ---
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã™
load_dotenv()

# --- æ¡ä»¶: é–¢æ•°ã‚’å®šç¾©ã—ã¦åˆ©ç”¨ã™ã‚‹ ---
# è³ªå•(user_text)ã¨å°‚é–€å®¶(expert_role)ã‚’å—ã‘å–ã£ã¦ã€AIã®ç­”ãˆã‚’è¿”ã™ã€Œé­”æ³•ã®ç®±ã€ã§ã™
def get_ai_response(user_text, expert_role):
    # LLMã®æº–å‚™ï¼ˆæœ€æ–°ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„ã¾ã™ï¼‰
    chat = ChatOpenAI(model="gpt-4o-mini")

    # æ¡ä»¶: ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠå€¤ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå½¹å‰²ï¼‰ã‚’å¤‰ãˆã‚‹
    if expert_role == "ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢":
        system_message = "ã‚ãªãŸã¯è¦ªåˆ‡ãªITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚å°‚é–€ç”¨èªã‚’ä¸­å­¦ç”Ÿã«ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚"
    else:
        system_message = "ã‚ãªãŸã¯æ­´å²å­¦ã®åšå£«ã§ã™ã€‚æ­´å²ã®å‡ºæ¥äº‹ã‚’ç‰©èªã®ã‚ˆã†ã«é¢ç™½ãèªã£ã¦ãã ã•ã„ã€‚"

    # AIã«æ¸¡ã™å‘½ä»¤ã‚’ä½œæˆ
    messages = [
        SystemMessage(content=system_message),
        HumanMessage(content=user_text),
    ]

    # AIã«è³ªå•ã‚’æŠ•ã’ã¦ã€ç­”ãˆã‚’å—ã‘å–ã‚‹
    response = chat.invoke(messages)
    return response.content

# --- æ¡ä»¶: Webã‚¢ãƒ—ãƒªã®æ¦‚è¦ã‚„æ“ä½œæ–¹æ³•ã‚’æ˜ç¤ºã™ã‚‹ ---
st.title("ğŸ¤– AIå°‚é–€å®¶ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª")
st.write("ã“ã®ã‚¢ãƒ—ãƒªã¯ã€é¸ã‚“ã å°‚é–€å®¶ãŒã‚ãªãŸã®ç–‘å•ã«ç­”ãˆã¦ãã‚Œã‚‹Webã‚¢ãƒ—ãƒªã§ã™ã€‚")
st.markdown("""
### ğŸ“– ä½¿ã„æ–¹
1. ä¸‹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§**ç›¸è«‡ã—ãŸã„ç›¸æ‰‹**ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
2. å…¥åŠ›æ¬„ã«**èããŸã„ã“ã¨**ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
3. é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨AIãŒå›ç­”ã—ã¾ã™ï¼
""")

# --- æ¡ä»¶: ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§å°‚é–€å®¶ã‚’é¸æŠå¯èƒ½ã«ã™ã‚‹ ---
expert = st.radio(
    "ç›¸è«‡ç›¸æ‰‹ã‚’é¸ã‚“ã§ã­ï¼š",
    ("ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", "æ­´å²ã®åšå£«")
)

# --- æ¡ä»¶: ç”»é¢ã«å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’1ã¤ç”¨æ„ã™ã‚‹ ---
user_input = st.text_input("è³ªå•ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š", placeholder="ä¾‹ï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã£ã¦ä½•ï¼Ÿ")

# ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
if st.button("AIã«ç›¸è«‡ã™ã‚‹"):
    if user_input:
        with st.spinner("AIãŒè€ƒãˆã¦ã„ã¾ã™..."):
            # æ¡ä»¶: å®šç¾©ã—ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã™
            result = get_ai_response(user_input, expert)
            
            # æ¡ä»¶: å›ç­”çµæœã‚’ç”»é¢ä¸Šã«è¡¨ç¤ºã™ã‚‹
            st.subheader("ğŸš© å›ç­”çµæœ")
            st.write(result)
    else:
        st.warning("ä½•ã‹æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼")